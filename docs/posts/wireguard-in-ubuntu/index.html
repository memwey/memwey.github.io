<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://memwey.github.io name=base><title>
            
                搭建 WireGuard 网络
            
        </title><meta content="搭建 WireGuard 网络" property=og:title><meta content="搭建 WireGuard 服务器端, 附带有客户端的一些配置" property=og:description><meta content="搭建 WireGuard 服务器端, 附带有客户端的一些配置" name=description><link href=https://memwey.github.io/fonts.css rel=stylesheet><script src="https://www.googletagmanager.com/gtag/js?id=G-VLQ5DBCKGT" async></script><script>window.dataLayer = window.dataLayer || [];
                function gtag(){dataLayer.push(arguments);}
                gtag('js', new Date());
                gtag('config', 'G-VLQ5DBCKGT');</script><script defer src=https://memwey.github.io/js/toc.js></script><link title="
    Mem.Wey's Github Pages
" href=https://memwey.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://memwey.github.io/theme/light.css rel=stylesheet><link href=https://memwey.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://memwey.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://memwey.github.io/main.css media=screen rel=stylesheet><body><div class=left-content></div><div class=content><nav><div class=left-nav><a href=https://memwey.github.io>Mem.Wey's Github Pages</a><div class=socials><a class=social href=https://x.com/Mem_Wey rel=me> <img alt=twitter src=https://memwey.github.io/icons/social/twitter.svg> </a><a class=social href=https://github.com/memwey rel=me> <img alt=github src=https://memwey.github.io/icons/social/github.svg> </a></div></div><div class=right-nav><a href=https://memwey.github.io/posts style=margin-right:.5em>/posts</a><a href=https://memwey.github.io/tags style=margin-right:.5em>/tags</a><a href=https://memwey.github.io/about style=margin-right:.5em>/about</a><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://memwey.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://memwey.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></div></nav><div data-selector="main article p" class=visible-element-observer-root><main><article><div class=title><div class=page-header>搭建 WireGuard 网络</div><div class=meta>Posted on <time>2022-11-29</time><span class=tags-label>::</span><span class=tags> <a class=post-tag href=https://memwey.github.io/tags/linux/>Linux</a> </span></div></div><section class=body><p>本文介绍在一台 <code>Ubuntu 22.04</code> 的服务器下搭建 WireGuard 服务器端, 附带有客户端的一些配置.<h2 id=an-zhuang><a aria-label="Anchor link for: an-zhuang" class=zola-anchor href=#an-zhuang>安装</a></h2><p>WireGuard 已经集成在 5.6 及以上版本的 Linux Kernel 中, <code>Ubuntu 22.04</code> 系统下直接安装即可<pre style=color:#c0c5ce;background-color:#2b303b><code><span>sudo apt update
</span><span>sudo apt install wireguard
</span></code></pre><h2 id=sheng-cheng-mi-yao-dui><a aria-label="Anchor link for: sheng-cheng-mi-yao-dui" class=zola-anchor href=#sheng-cheng-mi-yao-dui>生成密钥对</a></h2><pre style=color:#c0c5ce;background-color:#2b303b><code><span>cd /etc/wireguard
</span><span>wg genkey | tee s_private.key | wg pubkey > s_public.key
</span><span>wg genkey | tee c_private.key | wg pubkey > c_public.key
</span></code></pre><p>此时会在目录下生成四个文件, 具体说明如下<table><thead><tr><th>文件名<th>文件说明<tbody><tr><td>s_private.key<td>服务器端私钥<tr><td>s_public.key<td>服务器端公钥<tr><td>c_private.key<td>客户端私钥<tr><td>c_public.key<td>客户端公钥</table><h2 id=pei-zhi-wireguard-fu-wu-qi-duan><a aria-label="Anchor link for: pei-zhi-wireguard-fu-wu-qi-duan" class=zola-anchor href=#pei-zhi-wireguard-fu-wu-qi-duan>配置 WireGuard 服务器端</a></h2><p>具体需要各端准备的变量有以下这些<ul><li>服务器端: 公网 IP, 内网 IP, 公网端口, 公钥, 私钥, 网络接口<li>客户端: 内网 IP, 私钥, 公钥</ul><p>整理为如下表格<table><thead><tr><th><th>服务器端<th>客户端<tbody><tr><td>公网IP<td>233.233.233.233<td><tr><td>内网IP<td>192.168.1.1<td>192.168.1.2<tr><td>端口配置<td>udp/6666<td><tr><td>私钥文件<td>s_private.key<td>c_private.key<tr><td>公钥文件<td>s_public.key<td>c_public.key<tr><td>网络接口<td>eth0<td></table><h3 id=bian-xie-pei-zhi-wen-jian><a aria-label="Anchor link for: bian-xie-pei-zhi-wen-jian" class=zola-anchor href=#bian-xie-pei-zhi-wen-jian>编写配置文件</a></h3><p>文件位置为 <code>/etc/wireguard/wg0.conf</code><pre style=color:#c0c5ce;background-color:#2b303b><code><span>[Interface]
</span><span>Address = 192.168.1.1
</span><span>DNS = 223.6.6.6
</span><span>ListenPort = 6666
</span><span>PrivateKey = s_private.key
</span><span>PostUp   = iptables -A FORWARD -i wg0 -j ACCEPT; iptables -A FORWARD -o wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
</span><span>PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; iptables -D FORWARD -o wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE
</span><span>
</span><span>[Peer]
</span><span>PublicKey = c_public.key
</span><span>AllowedIPs = 192.168.1.2
</span></code></pre><p>其中 <code>Interface</code> 可以大致理解为本机的配置, 而 <code>Peer</code> 是面向外部的配置. 有一些参数需要按照实际情况调整, 密钥需要替换为实际的字符串<h3 id=qi-ta-fu-wu-qi-pei-zhi><a aria-label="Anchor link for: qi-ta-fu-wu-qi-pei-zhi" class=zola-anchor href=#qi-ta-fu-wu-qi-pei-zhi>其他服务器配置</a></h3><p>在服务器端启动 IP 转发<pre style=color:#c0c5ce;background-color:#2b303b><code><span>sysctl net.ipv4.ip_forward=1
</span></code></pre><p>另外, 可能需要云主机上配置开放对应的 UDP 端口<h3 id=qi-dong-yu-ting-zhi><a aria-label="Anchor link for: qi-dong-yu-ting-zhi" class=zola-anchor href=#qi-dong-yu-ting-zhi>启动与停止</a></h3><p>配置完成后, 可以使用如下命令, 分别是启动, 查看状态, 停止<pre style=color:#c0c5ce;background-color:#2b303b><code><span>wg-quick up wg0
</span><span>wg show wg0
</span><span>wg-quick down wg0
</span></code></pre><h2 id=wireguard-ke-hu-duan-pei-zhi><a aria-label="Anchor link for: wireguard-ke-hu-duan-pei-zhi" class=zola-anchor href=#wireguard-ke-hu-duan-pei-zhi>WireGuard 客户端配置</a></h2><h3 id=bian-xie-pei-zhi-wen-jian-1><a aria-label="Anchor link for: bian-xie-pei-zhi-wen-jian-1" class=zola-anchor href=#bian-xie-pei-zhi-wen-jian-1>编写配置文件</a></h3><p>文件命名为 <code>client.conf</code><pre style=color:#c0c5ce;background-color:#2b303b><code><span>[Interface]
</span><span>PrivateKey = c_private.key
</span><span>Address = 192.168.1.2
</span><span>DNS = 223.6.6.6
</span><span>
</span><span>[Peer]
</span><span>PublicKey = s_public.key
</span><span>Endpoint = 233.233.233.233:6666
</span><span>AllowedIPs = 0.0.0.0/0
</span><span>PersistentKeepalive = 25
</span></code></pre><p>也是要根据实际情况做相应的修改, 密钥替换为实际的字符串<h3 id=qi-ta-ke-hu-duan-pei-zhi><a aria-label="Anchor link for: qi-ta-ke-hu-duan-pei-zhi" class=zola-anchor href=#qi-ta-ke-hu-duan-pei-zhi>其他客户端配置</a></h3><p>可以使用如下命令在命令行生成二维码, 方便手机扫描<pre style=color:#c0c5ce;background-color:#2b303b><code><span>qrencode -t ansiutf8 &lt; client.conf
</span></code></pre></section></article></main></div></div><div class=right-content><div class=toc><div class=heading>Table of Contents</div><ul class=toc-list><li class=parent><a href=https://memwey.github.io/posts/wireguard-in-ubuntu/#an-zhuang>安装</a><li class=parent><a href=https://memwey.github.io/posts/wireguard-in-ubuntu/#sheng-cheng-mi-yao-dui>生成密钥对</a><li class=parent><a href=https://memwey.github.io/posts/wireguard-in-ubuntu/#pei-zhi-wireguard-fu-wu-qi-duan>配置 WireGuard 服务器端</a> <ul><li><a href=https://memwey.github.io/posts/wireguard-in-ubuntu/#bian-xie-pei-zhi-wen-jian>编写配置文件</a><li><a href=https://memwey.github.io/posts/wireguard-in-ubuntu/#qi-ta-fu-wu-qi-pei-zhi>其他服务器配置</a><li><a href=https://memwey.github.io/posts/wireguard-in-ubuntu/#qi-dong-yu-ting-zhi>启动与停止</a></ul><li class=parent><a href=https://memwey.github.io/posts/wireguard-in-ubuntu/#wireguard-ke-hu-duan-pei-zhi>WireGuard 客户端配置</a> <ul><li><a href=https://memwey.github.io/posts/wireguard-in-ubuntu/#bian-xie-pei-zhi-wen-jian-1>编写配置文件</a><li><a href=https://memwey.github.io/posts/wireguard-in-ubuntu/#qi-ta-ke-hu-duan-pei-zhi>其他客户端配置</a></ul></ul></div></div>