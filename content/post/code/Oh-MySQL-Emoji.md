---
title: "Oh MySQL Emoji"
date: 2019-10-14T11:12:33+08:00
draft: false
toc: true
authors:
  - memwey
images:
tags: 
  - Database
---

åˆæ˜¯å…³äº `MySQL` çš„, æ ‡é¢˜æ¥è‡ªäº <è½®åˆ°ä½ äº†> è¿™éƒ¨~~çƒ‚å°¾~~æ—¥å‰§, é‡Œé¢éå¸¸é­”æ€§çš„ Oh~my~Ju~lia~

åœ¨MySQLé‡Œé¢å¦‚ä½•ä¿å­˜ [Emoji](https://en.wikipedia.org/wiki/Emoji), è¿™ä¸ªé—®é¢˜æœä¸€æœå¾ˆå®¹æ˜“æ‰¾åˆ°ç­”æ¡ˆ, è®¾ç½® **CHARSET** ä¸º `utf8mb4`, çœ‹æ¥å¤©ä¸‹è‹¦ `MySQL` ä¹…çŸ£.

## åŸºç¡€çŸ¥è¯†

è®¡ç®—æœºæœ€æ—©æ˜¯ç¾å›½äººå‘æ˜çš„, é‚£æ—¶çš„ç¼–ç éƒ½æ˜¯ `ASCII` ç , æ¯•ç«Ÿè‹±æ–‡å­—ç¬¦åŠ ä¸Šæ ‡ç‚¹ç¬¦å·ä¹Ÿå°±é‚£ä¹ˆå¤šå˜›, ä¸€ä¸ªå­—èŠ‚ç»°ç»°æœ‰ä½™.

ä½†æ˜¯éšç€è®¡ç®—æœºçš„å‘å±•, è®¡ç®—æœºé¢å‘çš„å›½å®¶å’Œè¯­è¨€è¶Šæ¥è¶Šå¤š, ä¸€ä¸ªå­—èŠ‚æ ¹æœ¬ä¸å¤Ÿç”¨äº†, äºæ˜¯å°±æœ‰äº†å¾ˆå¤šé¢å‘ç‰¹å®šè¯­è¨€çš„ç¼–ç , æ¯”å¦‚æ±‰å­—çš„`GBK`, `Big5`, éŸ©æ–‡çš„ `EUC-KR`, æ—¥æ–‡çš„ `Shift_JIS` ä»€ä¹ˆçš„. æ€»ä½“æ€æƒ³æ˜¯, æ—¢ç„¶ä¸€ä¸ªå­—èŠ‚ä¸å¤Ÿç”¨, é‚£å°±å¤šå‡ ä¸ªå­—èŠ‚å°±æ˜¯äº†å˜›.

ä½†æ˜¯é—®é¢˜åˆå‡ºç°äº†, åŒä¸€ä¸ªç¼–ç åœ¨ä¸åŒè¯­è¨€ä¸­ä¼šæœ‰ä¸åŒçš„å«ä¹‰,æ¯”å¦‚éŸ©æ–‡ç¼–ç  `EUC-KR` ä¸­ `í•œêµ­ì–´` çš„ç¼–ç å€¼æ­£å¥½å¯¹åº”ç€æ±‰å­—ç¼–ç  `GBK` ä¸­çš„ `èŒ„æƒ«ç»¢`. è¿˜æœ‰é‚£ä¸ªè‘—åçš„ `ç“£Bå˜å·¨è‚š`, ä¹Ÿæ­£æ˜¯åŒæ ·çš„åŸå› . è¿™æ ·ä»¿ä½›å°±å˜æˆäº†å·´åˆ«å¡”çš„æ•…äº‹. äººä»¬è™½ç„¶ç”¨ç€åŒæ ·çš„äºŒè¿›åˆ¶ç¼–ç , ä½†æ˜¯å´è¡¨è¾¾ç€ä¸åŒçš„æ„æ€; å°±åƒäººä»¬è™½ç„¶åŒæ ·å‘å‡ºå£°å¸¦çš„éœ‡åŠ¨, ä½†æ˜¯å´æ— æ³•äº’ç›¸ç†è§£å¯¹æ–¹çš„è¯è¯­.

[å›½é™…æ ‡å‡†åŒ–ç»„ç»‡](https://en.wikipedia.org/wiki/International_Organization_for_Standardization) å’Œ [ç»Ÿä¸€ç è”ç›Ÿ](https://en.wikipedia.org/wiki/Unicode_Consortium) æ„è¯†åˆ°, è¿™æ ·ä¸‹å»æ˜¯ä¸è¡Œçš„, ä¸å¦‚æä¸€ä¸ªè¶…å¤§çš„å­—ç¬¦é›†, ç„¶åæŠŠäººç±»æ‰€æœ‰å­—ç¬¦éƒ½å¼„è¿›å», è¿™æ ·äººç±»éƒ½å¯ä»¥ç”¨åŒä¸€ä¸ªæ ‡å‡†äº†. äºæ˜¯, ä»–ä»¬åˆ†åˆ«åˆ¶å®šäº† [USC](https://en.wikipedia.org/wiki/Universal_Coded_Character_Set) å’Œ [Unicode](https://en.wikipedia.org/wiki/Unicode). å½“ç„¶, å¦‚æœä¸¤ä¸ªæ ‡å‡†å„æå„çš„, é‚£å°±å’Œä»–ä»¬æœ€åˆçš„æƒ³æ³•èƒŒé“è€Œé©°äº†, æ‰€ä»¥ç›®å‰è¿™ä¸¤ä¸ªå­—ç¬¦é›†åœ¨å®é™…ä½¿ç”¨ä¸­æ˜¯ä¸€è‡´çš„. ä¸€èˆ¬è¿˜æ˜¯æŠŠè¿™ä¸ªå­—ç¬¦é›†å« `Unicode`.

`Unicode` çš„èŒƒå›´ä¸Šé™æ˜¯ `0x10FFFF`, æ¢ç®—æˆåè¿›åˆ¶å°±æ˜¯ `1,114,111` è¿™ä¹ˆå¤š. æ‰€ä»¥å¦‚æœä»¥åå¤–æ˜Ÿäººçš„æ–‡å­—å¤ªå¤š, è¯´ä¸å®šè¿™ä¸ªèŒƒå›´å°±ä¸å¤Ÿäº†.

å…¶å®è¿™é‡Œæ‚„æ‚„çš„å·æ¢äº†ä¸€ä¸ªæ¦‚å¿µ, ä¹‹å‰åœ¨è¯´ç¼–ç , ç°åœ¨å˜æˆäº†å­—ç¬¦é›†äº†. åœ¨å¾ˆå¤šä¹‹å‰æåˆ°çš„ç¼–ç ä¸­, è¿™äº›ç¼–ç æ—¢æ˜¯å­—ç¬¦é›†, åˆæ˜¯ç›´æ¥çš„ç¼–ç . è€Œåœ¨ `Unicode` ä¸­, å­—ç¬¦é›†å®é™…ä¸Šæ˜¯ä¸ç¼–ç åˆ†å¼€çš„ä¸¤ä¸ªæ¦‚å¿µ, è€Œå¯¹åº”çš„ç¼–ç , å®é™…ä¸Šå°±æ˜¯æˆ‘ä»¬ç»å¸¸è§åˆ°çš„ `UTF`. å…¶ä¸­ `UTF-8` æ˜¯æˆ‘ä»¬æœ€å¸¸è§çš„ä¸€ç§ç¼–ç äº†.

`UTF-8` æœ€å¤§çš„ç‰¹ç‚¹, å°±æ˜¯å®ƒæ˜¯ä¸€ç§å˜é•¿çš„ç¼–ç æ–¹å¼, è€Œä¸”å®Œå…¨å…¼å®¹ `ASCII`ç .

`UTF-8` çš„ç¼–ç è§„åˆ™ä¹Ÿå¾ˆç®€å•ï¼Œåªæœ‰äºŒæ¡:

* å¯¹äºå•å­—èŠ‚çš„ç¬¦å·, å­—èŠ‚çš„ç¬¬ä¸€ä½è®¾ä¸º`0`, åé¢7ä½ä¸ºè¿™ä¸ªç¬¦å·çš„ Unicode ç . å¯¹äº `0 - 127` ä½çš„å­—ç¬¦ï¼ŒUTF-8 ç¼–ç å’Œ ASCII ç æ˜¯å®Œå…¨ç›¸åŒçš„.

* å¯¹äº `n` å­—èŠ‚çš„ç¬¦å· `(n > 1)` , ç¬¬ä¸€ä¸ªå­—èŠ‚çš„å‰ `n` ä½éƒ½è®¾ä¸º `1`, ç¬¬ `n + 1` ä½è®¾ä¸º `0`, åé¢å­—èŠ‚çš„å‰ä¸¤ä½ä¸€å¾‹è®¾ä¸º `10`. å‰©ä¸‹çš„æ²¡æœ‰æåŠçš„äºŒè¿›åˆ¶ä½, å…¨éƒ¨ä¸ºè¿™ä¸ªç¬¦å·çš„ Unicode ç .

| Unicodeç¬¦å·èŒƒå›´     |        UTF-8ç¼–ç æ–¹å¼
| --- | --- |
| U+0000 - U+007F | 0xxxxxxx |
| U+0080 - U+07FF | 110xxxxx 10xxxxxx |
| U+0800 - U+FFFF | 1110xxxx 10xxxxxx 10xxxxxx |
| U+010000 - U+10FFFF | 11110xxx 10xxxxxx 10xxxxxx 10xxxxxx |

åœ¨è¿™é‡Œæˆ‘ä»¬å‘ç°, `U+0000 - U+FFFF` è¿™ä¸ª**å¹³é¢**(Plane), å³**åŸºæœ¬å¤šæ–‡ç§å¹³é¢**, ç®€ç§° `BMP`, ç”¨ `UTF-8` è¿›è¡Œç¼–ç , åªéœ€è¦ä¸‰ä¸ªå­—èŠ‚.

## è½®åˆ°ä½ äº†

åœ¨ `MySQL` çš„ **CHARSET** ä¸­, `utf8` æ”¯æŒå­˜å‚¨ 1 - 3å­—èŠ‚çš„å­—ç¬¦, å³å¯¹åº” `Unicode` ä¸­ `BMP` çš„éƒ¨åˆ†, è€Œ [Emoji](https://en.wikipedia.org/wiki/Emoji), åˆ™å¤§å¤šæ•°åœ¨ `BMP` ä¹‹å¤–. æ‰€ä»¥ `MySQL` ä¸­çš„ `utf8` æ˜¯å‡çš„, æ˜¯åŒ–å­¦çš„æˆåˆ†, æ˜¯åŠ äº†ç‰¹æŠ€çš„. å¦‚æœæƒ³å‚¨å­˜çœŸæ­£çš„ `UTF-8` çš„å†…å®¹, å°±ä¸€å®šè¦ä½¿ç”¨ `utf8mb4`.

å½“ç„¶, å¹¶ä¸æ˜¯æ‰€æœ‰çš„ [Emoji](https://en.wikipedia.org/wiki/Emoji) éƒ½åœ¨ `BMP` ä¹‹å¤–, æ¯”å¦‚ â˜º è¿™ä¸ªè¡¨æƒ…, å®ƒçš„ç¼–ç æ˜¯ `U+263A`, è¿˜æœ‰ â˜¹ï¸ , ç¼–ç æ˜¯ `U+2639`.

å½“ç„¶, ä¹Ÿä¸æ˜¯æ‰€æœ‰çš„æ±‰å­—éƒ½è¢«åŒ…å«åœ¨äº† `BMP` é‡Œé¢äº†, åœ¨ [è¿™é‡Œ](https://www.compart.com/en/unicode/block) å¯ä»¥çœ‹åˆ°å­—ç¬¦æ˜¯æŒ‰ç…§ä¸€å®šçš„è§„å¾‹åˆ’åˆ†ä¸º `Block` æ”¾è¿›æ¥çš„, åœ¨**è¡¨æ„æ–‡å­—è¡¥å……å¹³é¢**ä¹Ÿå°±æ˜¯ `U+20000 - U+2FFFF` è¿™ä¸ª**å¹³é¢**(Plane), è¿˜æ˜¯æœ‰å¾ˆå¤š `CJK` å‘½åçš„ `Block` çš„.

## å†æ¥ä¸€ç“¶

ä½ ä»¥ä¸ºå‘åˆ°è¿™é‡Œå°±ç»“æŸäº†å—

```SQL
CREATE TABLE `emoji_test` (
  `id` INT UNSIGNED NOT NULL AUTO_INCREMENT,
  `emoji` VARCHAR(1024) NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

```SQL
SET NAMES utf8mb4;
```

```bash
MySQL [test]> SELECT * FROM emoji_test;
+----+-------+
| id | emoji |
+----+-------+
|  8 | ğŸ˜ƒ      |
|  9 | ğŸ˜‚      |
| 10 | ğŸ¤¦      |
+----+-------+
3 rows in set (0.001 sec)

MySQL [test]> SELECT * FROM emoji_test WHERE emoji = 'ğŸ˜‚';
+----+-------+
| id | emoji |
+----+-------+
|  8 | ğŸ˜ƒ      |
|  9 | ğŸ˜‚      |
| 10 | ğŸ¤¦      |
+----+-------+
3 rows in set (0.001 sec)
```

æ˜¯ä¸æ˜¯å¾ˆç¥å¥‡å‘¢, çœ‹ä¸‹è¡¨çš„ä¿¡æ¯å‘¢

```SQL
MySQL [test]> SHOW TABLE STATUS WHERE Name = 'emoji_test';
+------------+--------+---------+------------+------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+---------------------+------------+--------------------+----------+----------------+---------+
| Name       | Engine | Version | Row_format | Rows | Avg_row_length | Data_length | Max_data_length | Index_length | Data_free | Auto_increment | Create_time         | Update_time         | Check_time | Collation          | Checksum | Create_options | Comment |
+------------+--------+---------+------------+------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+---------------------+------------+--------------------+----------+----------------+---------+
| emoji_test | InnoDB |      10 | Dynamic    |    3 |           5461 |       16384 |               0 |            0 |         0 |             11 | 2019-10-16 11:16:28 | 2019-10-16 11:25:10 | NULL       | utf8mb4_general_ci |     NULL |                |         |
+------------+--------+---------+------------+------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+---------------------+------------+--------------------+----------+----------------+---------+
1 row in set (0.001 sec)
```

å¯ä»¥çœ‹åˆ°æ­¤æ—¶é»˜è®¤çš„å­—ç¬¦åºæ˜¯ `utf8mb4_general_ci`, ä½¿ç”¨ `WEIGHT_STRING` æ¥æŸ¥è¯¢è¿™äº› Emoji çš„å­—ç¬¦åº

```SQL
MySQL [test]> SET @s = 'ğŸ˜‚' COLLATE utf8mb4_general_ci;
Query OK, 0 rows affected (0.003 sec)

MySQL [test]> SELECT @s, HEX(@s), HEX(WEIGHT_STRING(@s));
+------+----------+------------------------+
| @s   | HEX(@s)  | HEX(WEIGHT_STRING(@s)) |
+------+----------+------------------------+
| ğŸ˜‚     | F09F9882 | FFFD                   |
+------+----------+------------------------+
1 row in set (0.001 sec)

MySQL [test]> SET @s = 'ğŸ˜ƒ' COLLATE utf8mb4_general_ci;
Query OK, 0 rows affected (0.001 sec)

MySQL [test]> SELECT @s, HEX(@s), HEX(WEIGHT_STRING(@s));
+------+----------+------------------------+
| @s   | HEX(@s)  | HEX(WEIGHT_STRING(@s)) |
+------+----------+------------------------+
| ğŸ˜ƒ     | F09F9883 | FFFD                   |
+------+----------+------------------------+
1 row in set (0.001 sec)
```

å¯ä»¥çœ‹åˆ°, å®ƒä»¬çš„ç¼–ç è™½ç„¶ä¸åŒ, ä½†æ˜¯å­—ç¬¦åºçš„å€¼æ˜¯ç›¸åŒçš„, éƒ½æ˜¯ `0xFFFD`, æ‰€ä»¥åœ¨åŒ¹é…çš„æ—¶å€™, å®ƒä»¬è¢«è®¤ä¸ºæ˜¯åŒä¸€ä¸ªå­—ç¬¦, è¿™åˆæ˜¯ `MySQL` çš„ä¸€ä¸ªå¤§å‘

è¦æ˜¯æƒ³ç²—æš´ç‚¹è§£å†³é—®é¢˜çš„è¯, ç›´æ¥ä½¿ç”¨ `utf8mb4_bin` ä½œä¸ºå­—ç¬¦åºå°±å¥½äº†

## åˆæ¥ä¸€ç“¶

ä½†æ˜¯è¿™è¿˜ä¸æ˜¯ç»“æŸ, å½“ä¸šåŠ¡ä»£ç è¿æ¥æ•°æ®åº“å¹¶æ’å…¥ä¸€äº› Emoji æ—¶, è¿˜æ˜¯å¯èƒ½é‡åˆ°å¦‚ä¸‹é”™è¯¯

```
ERROR 1366: Incorrect string value: '\xF0\x9D\x8C\x86' for column 'column_name' at row 1
```

è¿™ä¸ªæ˜¯å› ä¸ºå®¢æˆ·ç«¯åˆ° MySQL æœåŠ¡å™¨çš„è¿æ¥è¿˜æ˜¯ utf8 è€Œé utf8mb4, æ‰€ä»¥ä½ éœ€è¦åœ¨ä¸šåŠ¡é€»è¾‘ä¸­åšç±»ä¼¼å¦‚ä¸‹è¯­å¥çš„äº‹æƒ…

```
SET NAMES utf8mb4
```

æˆ–è€…ä¿®æ”¹ MySQL çš„é…ç½®æ–‡ä»¶, å½“ç„¶è¿™æ ·ä¸å¤ªç°å®, éœ€è¦é‡å¯ MySQL è¿›ç¨‹. 

è¿™æ ·ä½ æ‰èƒ½ç»ˆäºç”¨ä¸Š Emoji

## å‚è€ƒèµ„æ–™

1. [How can I search by emoji in MySQL using utf8mb4?](https://stackoverflow.com/questions/41147829/how-can-i-search-by-emoji-in-mysql-using-utf8mb4)
2. [å­—ç¬¦ç¼–ç ç¬”è®°ï¼šASCIIï¼ŒUnicode å’Œ UTF-8
](http://www.ruanyifeng.com/blog/2007/10/ascii_unicode_and_utf-8.html)
3. [å¦‚ä½•é€šä¿—åœ°ç†è§£Unicodeã€UTF-8ã€ASCIIã€GBKç­‰å­—ç¬¦ç¼–ç ï¼Ÿ](https://www.zhihu.com/question/60072951)
4. [In MySQL, never use â€œutf8â€. Use â€œutf8mb4â€.](https://medium.com/@adamhooper/in-mysql-never-use-utf8-use-utf8mb4-11761243e434)
5. [How to support full Unicode in MySQL databases](https://mathiasbynens.be/notes/mysql-utf8mb4)
6. [Connection Character Sets and Collations](https://dev.mysql.com/doc/refman/5.7/en/charset-connection.html)
7. [â€œIncorrect string valueâ€ when trying to insert UTF-8 into MySQL via JDBC?](https://stackoverflow.com/questions/10957238/incorrect-string-value-when-trying-to-insert-utf-8-into-mysql-via-jdbc)

## æ‰©å±•é˜…è¯»

1. [å…¶å®ä½ å¹¶ä¸æ‡‚ Unicode](https://zhuanlan.zhihu.com/p/53714077)
2. [Dark corners of Unicode](https://eev.ee/blog/2015/09/12/dark-corners-of-unicode/)
3. [MySQL Â· å®ç°åˆ†æ Â· å¯¹å­—ç¬¦é›†å’Œå­—ç¬¦åºæ”¯æŒçš„å®ç°](http://mysql.taobao.org/monthly/2017/03/06/)
4. [unicodedata â€” Unicode Database](https://docs.python.org/3.7/library/unicodedata.html)
